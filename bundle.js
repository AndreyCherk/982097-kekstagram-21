(()=>{"use strict";(()=>{const e=(e,t)=>Math.floor(e+Math.random()*(t+1-e));window.util={getRatio:(e,t,n)=>(t-e)*n/100+e,getRandomInteger:e,getRandomArrayItem:t=>t[e(0,t.length-1)],clearElement:(e,t)=>{const n=e.children;for(let o=n.length-1;o>=0;o--)t&&t.includes(n[o].tagName.toLowerCase(),0)||e.removeChild(n[o])},shuffle:e=>{for(let t=e.length-1;t>0;t--){let n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e},debounce:(e,t)=>{let n=null;return(...o)=>{n&&window.clearTimeout(n),n=window.setTimeout((()=>{e(...o)}),t)}},isEscEvent:(e,t)=>{"Escape"===e.key&&(e.preventDefault(),t())}}})(),window.load=(e,t,n,o,i,r)=>{const l=new XMLHttpRequest;l.responseType="json",l.timeout=i,l.addEventListener("load",(()=>{200===l.status?n(l.response):o("Статус ответа: "+l.status+" "+l.statusText)})),l.addEventListener("error",(()=>{o("Произошла ошибка соединения")})),l.addEventListener("timeout",(()=>{o("Запрос не успел выполниться за "+l.timeout+"мс")})),l.open(t,e),r?l.send(r):l.send()},(()=>{const e=document.querySelector(".big-picture"),t=e.querySelector(".big-picture__img img"),n=e.querySelector(".big-picture__cancel"),o=e.querySelector(".social__caption"),i=e.querySelector(".likes-count"),r=e.querySelector(".social__comment-count"),l=e.querySelector(".social__comments"),s=e.querySelector(".social__comment"),a=e.querySelector(".comments-loader"),c=document.querySelector("body");r.innerHTML="<span></span>"+r.innerHTML.slice(1);const d=r.querySelector("span"),u=r.querySelector(".comments-count"),m=()=>{const e=Array.from(l.querySelectorAll(".hidden")),t=e.length<=5?e.length:5;for(let n=0;n<t;n++)e[n].classList.remove("hidden");e.splice(0,t),e.length||(a.classList.add("hidden"),a.removeEventListener("click",m)),d.textContent=+d.textContent+t},g=e=>{window.util.isEscEvent(e,w)},p=()=>{w()},w=()=>{e.classList.add("hidden"),c.classList.remove("modal-open"),document.removeEventListener("keydown",g),n.removeEventListener("click",p),a.removeEventListener("click",m)};window.fullSizePicture={render:e=>{t.src=e.url,i.textContent=e.likes,u.textContent=e.comments.length,o.textContent=e.description,window.util.clearElement(l),(e=>{let t=e.length;e.forEach(((e,n)=>{let o=(e=>{const t=s.cloneNode(!0),n=t.querySelector("img");return n.src=e.avatar,n.alt=e.name,t.querySelector(".social__text").textContent=e.message,t})(e);l.appendChild(o),n>4&&(o.classList.add("hidden"),t-=1)})),d.textContent=t})(e.comments),e.comments.length>5?(a.classList.remove("hidden"),a.addEventListener("click",m)):a.classList.add("hidden")},open:()=>{e.classList.remove("hidden"),c.classList.add("modal-open"),document.addEventListener("keydown",g),n.addEventListener("click",p)}}})(),(()=>{const e=document.querySelector(".pictures"),t=document.querySelector("#picture").content.querySelector(".picture"),n=e=>{const n=t.cloneNode(!0);return n.querySelector(".picture__img").src=e.url,n.querySelector(".picture__comments").textContent=e.comments.length,n.querySelector(".picture__likes").textContent=e.likes,n.addEventListener("click",(t=>{t.preventDefault(),window.fullSizePicture.render(e),window.fullSizePicture.open()})),n};window.picturesRendering={render:t=>{const o=document.createDocumentFragment(),i=t.length<=25?t.length:25;for(let e=0;e<i;e++)o.appendChild(n(t[e]));e.appendChild(o)}}})(),(()=>{const e=document.querySelector(".img-filters"),t=e.querySelectorAll(".img-filters__button"),n=document.querySelector(".pictures");window.picturesFilters={activate:o=>{e.classList.remove("img-filters--inactive"),e.addEventListener("click",(e=>window.util.debounce((o=>{let i=e;var r;o.target.matches("#filter-random")&&(i=(e=>window.util.shuffle(e).slice(0,10))(e)),o.target.matches("#filter-discussed")&&(i=(e=>e.slice(0).sort(((e,t)=>{let n=t.comments.length-e.comments.length;return 0===n&&(n=1),n})))(e)),window.util.clearElement(n,["h2","section"]),window.picturesRendering.render(i),r=o.target,t.forEach((e=>{e.classList.remove("img-filters__button--active")})),r.classList.add("img-filters__button--active")}),500))(o))}}})(),(()=>{const e=document.querySelector("body");window.pictures={load:e=>{window.picturesRendering.render(e),window.picturesFilters.activate(e)},errorLoad:t=>{const n=document.createElement("div"),o=document.createElement("img"),i=document.createElement("span");o.src="img/icon-warning.svg",o.style="width: 30px; height: 30px; margin-right: 20px; vertical-align: bottom;",i.textContent=t,n.style='position: absolute; top: 10px; right: 0; left: 0; padding: 10px; font-family: "Open Sans", "Arial", sans-serif; text-align: center; font-weight: 700; font-size: 20px; color: #ffe753; background-color: #3c3614; border-radius: 10px;',n.classList.add("container"),n.appendChild(o),n.appendChild(i),e.appendChild(n)}}})(),(()=>{const e=document.querySelector("body").querySelector("main"),t=document.querySelector("#success").content.querySelector(".success"),n=document.querySelector("#error").content.querySelector(".error");let o;const i=()=>{o.remove(),document.removeEventListener("keydown",r),document.removeEventListener("click",l)},r=e=>{window.util.isEscEvent(e,i)},l=e=>{e.target.matches('[class$="inner"]')||(e.preventDefault(),i())},s=()=>{i()};window.uploadFormStatusMessage={open:i=>{"success"===i?o=t.cloneNode(!0):"error"===i&&(o=n.cloneNode(!0)),document.addEventListener("keydown",r),document.addEventListener("click",l),o.querySelector(`.${i}__button`).addEventListener("click",s),e.appendChild(o)}}})(),(()=>{const e=100,t={chrome:{minValue:0,maxValue:1,getLevel(e){return`grayscale(${window.util.getRatio(this.minValue,this.maxValue,e)})`}},sepia:{minValue:0,maxValue:1,getLevel(e){return`sepia(${window.util.getRatio(this.minValue,this.maxValue,e)})`}},marvin:{minValue:0,maxValue:1,getLevel(e){return`invert(${window.util.getRatio(this.minValue,this.maxValue,e)})`}},phobos:{minValue:0,maxValue:3,getLevel(e){return`blur(${window.util.getRatio(this.minValue,this.maxValue,e)}px)`}},heat:{minValue:1,maxValue:3,getLevel(e){return`brightness(${window.util.getRatio(this.minValue,this.maxValue,e)})`}}},n=document.querySelector(".img-upload__overlay"),o=n.querySelector(".img-upload__preview img"),i=n.querySelector(".effect-level"),r=i.querySelector(".effect-level__value"),l=i.querySelector(".effect-level__line"),s=l.querySelector(".effect-level__depth"),a=l.querySelector(".effect-level__pin"),c=n.querySelector(".scale__control--value");let d,u,m;const g=()=>{i.classList.add("hidden"),a.style.left="100%",s.style.width="100%",o.classList.remove(m),o.style.filter="",r.setAttribute("value",100)},p=e=>{o.style.filter=t[u].getLevel(e),a.style.left=e+"%",s.style.width=e+"%",r.setAttribute("value",e)};window.uploadFormImageSettings={onPlusScaleButtonClick:()=>{d<100&&(d+=25,c.setAttribute("value",d+"%"),o.style.transform=`scale(${d/100})`)},onMinusScaleButtonClick:()=>{d>25&&(d-=25,c.setAttribute("value",d+"%"),o.style.transform=`scale(${d/100})`)},getDefaultScaleSettings:()=>{d=100,c.setAttribute("value",d+"%"),o.style.transform=`scale(${d/100})`},getDefaultEffectSettings:g,onEffectChange:e=>{e.target.matches('input[type="radio"]')&&(g(),"none"!==e.target.value&&(u=e.target.value,m="effects__preview--"+u,o.classList.add(m),o.style.filter=t[u].getLevel(100),i.classList.remove("hidden")))},onEffectPinMouseDown:()=>{const t=t=>{const n=(t.clientX-l.getBoundingClientRect().left)/l.offsetWidth*100;p(n>e?e:n<0?0:n)},n=()=>{document.removeEventListener("mousemove",t),document.removeEventListener("mouseup",n)};document.addEventListener("mousemove",t),document.addEventListener("mouseup",n)},onEffectRangeClick:e=>{const t=(e.clientX-l.getBoundingClientRect().left)/l.offsetWidth*100;p(t)},onEffectPinKeydown:t=>{const n=+a.style.left.slice(0,-1);"ArrowLeft"===t.key?n>=1?p(n-1):n>0&&n<1&&p(0):"ArrowRight"===t.key&&(n<=99?p(n+1):n<e&&n>99&&p(e))}}})(),(()=>{const e=document.querySelector(".img-upload__overlay"),t=e.querySelector(".text__hashtags"),n=e.querySelector(".text__description"),o=/^#[a-zA-Zа-яА-Я0-9]*$/;window.uploadFormValidity={onHashtagInputInput:()=>{if(t.value){const e=t.value.toLowerCase().split(" ");if(e.forEach(((t,n)=>{""===t&&e.splice(n,1)})),e.length>5)t.setCustomValidity("Нельзя указать больше 5 хэштегов");else for(let n=0;n<e.length;n++){if(e.includes(e[n],n+1)){t.setCustomValidity("Один и тот же хэштег не может быть использован дважды");break}if(e[n].length>20){t.setCustomValidity("Длина хэштега не должна превышать 20 симв.");break}if("#"!==e[n][0]){t.setCustomValidity("Хэштег должен начинаться с символа решётки");break}if(1===e[n].length){t.setCustomValidity("Хэштег не должен состоять только из одной решётки");break}if(!o.test(e[n])){t.setCustomValidity("Хэштег не должен содержать специальных символов");break}t.setCustomValidity("")}}else t.setCustomValidity("");t.reportValidity(),""!==t.validationMessage?t.style.boxShadow="0 0 0 2px #ff4e4e":t.style.boxShadow="none"},onCommentInputInput:()=>{const e=n.value.length;e>140?n.setCustomValidity(`Удалите лишние ${e-140} симв.`):n.setCustomValidity(""),n.reportValidity(),""!==n.validationMessage?n.style.boxShadow="0 0 0 2px #ff4e4e":n.style.boxShadow="none"}}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector(".img-upload__form"),n=t.querySelector(".img-upload__overlay"),o=t.querySelector(".img-upload__input"),i=n.querySelector(".img-upload__cancel"),r=n.querySelector(".img-upload__preview img"),l=n.querySelectorAll(".effects__preview"),s=n.querySelector(".effect-level").querySelector(".effect-level__line"),a=s.querySelector(".effect-level__pin"),c=t.querySelector(".scale__control--bigger"),d=t.querySelector(".scale__control--smaller"),u=t.querySelector(".text__hashtags"),m=t.querySelector(".text__description"),g=document.querySelector("body"),p=e=>{window.util.isEscEvent(e,(()=>{document.activeElement!==u&&document.activeElement!==m&&S()}))},w=()=>{S()},v=e=>{e.preventDefault(),window.load("https://21.javascript.pages.academy/kekstagram","POST",f,y,1e4,new FormData(t))},f=()=>{window.uploadFormStatusMessage.open("success"),S()},y=()=>{window.uploadFormStatusMessage.open("error"),S()},S=()=>{n.classList.add("hidden"),g.classList.remove("modal-open"),t.reset(),r.src="img/upload-default-image.jpg",u.style.boxShadow="none",m.style.boxShadow="none",window.uploadFormImageSettings.getDefaultEffectSettings(),window.uploadFormImageSettings.getDefaultScaleSettings(),document.removeEventListener("keydown",p),i.removeEventListener("click",w),t.removeEventListener("change",window.uploadFormImageSettings.onEffectChange),s.removeEventListener("click",window.uploadFormImageSettings.onEffectRangeClick),a.removeEventListener("mousedown",window.uploadFormImageSettings.onEffectPinMouseDown),a.removeEventListener("keydown",window.uploadFormImageSettings.onEffectPinKeydown),c.removeEventListener("click",window.uploadFormImageSettings.onPlusScaleButtonClick),d.removeEventListener("click",window.uploadFormImageSettings.onMinusScaleButtonClick),u.removeEventListener("input",window.uploadFormValidity.onHashtagInputInput),m.removeEventListener("input",window.uploadFormValidity.onCommentInputInput),t.removeEventListener("submit",v)};window.uploadForm={render:()=>{const t=o.files[0],n=t.name.toLowerCase();if(e.some((e=>n.endsWith(e)))){const e=URL.createObjectURL(t);r.src=e,l.forEach((t=>{t.style.backgroundImage=`url(${e})`}))}},open:()=>{n.classList.remove("hidden"),g.classList.add("modal-open"),document.addEventListener("keydown",p),i.addEventListener("click",w),t.addEventListener("change",window.uploadFormImageSettings.onEffectChange),s.addEventListener("click",window.uploadFormImageSettings.onEffectRangeClick),a.addEventListener("mousedown",window.uploadFormImageSettings.onEffectPinMouseDown),a.addEventListener("keydown",window.uploadFormImageSettings.onEffectPinKeydown),c.addEventListener("click",window.uploadFormImageSettings.onPlusScaleButtonClick),d.addEventListener("click",window.uploadFormImageSettings.onMinusScaleButtonClick),u.addEventListener("input",window.uploadFormValidity.onHashtagInputInput),m.addEventListener("input",window.uploadFormValidity.onCommentInputInput),t.addEventListener("submit",v)}}})(),(()=>{window.load("https://21.javascript.pages.academy/kekstagram/data","GET",window.pictures.load,window.pictures.errorLoad,1e4);const e=document.querySelector(".img-upload__input");window.uploadFormImageSettings.getDefaultEffectSettings(),window.uploadFormImageSettings.getDefaultScaleSettings(),e.addEventListener("change",(()=>{window.uploadForm.render(),window.uploadForm.open()}))})()})();